<?php

/**
 * Drago Extension
 * Package built on the Nette Framework
 */

declare(strict_types=1);

namespace Drago\Datagrid\PageSize;

use Closure;
use Drago\Datagrid\Options;
use Nette\Application\UI\Control;
use Nette\Application\UI\Form;


/**
 * @property-read PageSizeTemplate $template
 */
final class PageSizeControl extends Control
{
	private ?Closure $onPageChanged = null;

	/** Total number of items in the DataGrid */
	private int $totalItems = 0;

	/** Current number of items per page */
	private int $currentPageSize = Options::DefaultItemsPerPage;


	/**
	 * Registers a callback executed when page size is changed.
	 */
	public function onPageChanged(callable $callback): void
	{
		$this->onPageChanged = $callback;
	}


	/**
	 * Sets total number of items in the DataGrid.
	 */
	public function setTotalItems(int $totalItems): void
	{
		$this->totalItems = $totalItems;
	}


	/**
	 * Sets current page size.
	 */
	public function setCurrentPageSize(int $size): void
	{
		$this->currentPageSize = $size;
	}


	/**
	 * Creates form for selecting number of items per page.
	 */
	protected function createComponentForm(): Form
	{
		$form = new Form();

		$form->addSelect('pageSize', 'Items per page', items: [
			20 => '20',
			50 => '50',
			100 => '100',
			0 => 'All',
		])
			->setDefaultValue($this->currentPageSize)
			->setHtmlAttribute('data-items-page');

		$form->onSuccess[] = function (Form $form, \stdClass $values): void {
			$size = (int) $values->pageSize;
			if ($size === 0) {
				$size = $this->totalItems;
			}

			if ($this->onPageChanged) {
				($this->onPageChanged)(Options::DefaultPage, $size);
			}
		};

		return $form;
	}


	/**
	 * Renders page size control.
	 */
	public function render(): void
	{
		$this->template->setFile(__DIR__ . '/PageSize.latte');
		$this->template->render();
	}
}
